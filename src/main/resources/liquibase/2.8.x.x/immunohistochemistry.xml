<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
	 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
	 
  	<property name="now" value="now()" dbms="postgresql"/>
			
	<changeSet author="csteele" id="1">
	<validCheckSum>8:ab895f74386ecc421575297f4641e78b</validCheckSum>
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="immunohistochemistry_sample" schemaName="clinlims" />
			</not>
		</preConditions>
		<comment>create immunohistochemistry table</comment>
		<createTable tableName="immunohistochemistry_sample">
			<column name="id" type="INTEGER" valueSequenceNext="program_sample_seq">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="technician_id" type="NUMERIC(10)"/>
			<column name="pathologist_id" type="NUMERIC(10)"/>
			<column name="program_id" type="NUMERIC(10)"/>
			<column name="sample_id" type="NUMERIC(10)"/>
			<column name="status" type="VARCHAR(255)"/>
			<column name="questionnaire_response_uuid" type="uuid" />
			<column name="last_updated" type="datetime"/>
		</createTable>
		<addForeignKeyConstraint constraintName="immunohistochemistry_sample_program_id_fk"
                                 baseTableName="immunohistochemistry_sample" baseColumnNames="program_id"
                                 referencedTableName="program" referencedColumnNames="id"/>
		<addForeignKeyConstraint constraintName="immunohistochemistry_sample_sample_id_fk"
                                 baseTableName="immunohistochemistry_sample" baseColumnNames="sample_id"
                                 referencedTableName="sample" referencedColumnNames="id"/>
	</changeSet>

	<changeSet author="mozzymutesa" id="2">
		<preConditions onFail="MARK_RAN">
        	<sqlCheck expectedResult="0">select count(*) from clinlims.test_section where name = 'Immunohistochemistry'; </sqlCheck>
		</preConditions>
		<comment>Add Immunohistochemistry test section</comment>
		<insert schemaName="clinlims" tableName="localization">
			<column name="id" valueSequenceNext="localization_seq" />
			<column name="lastupdated" valueComputed="${now}" />
			<column name="description" value="Immunohistochemistry test section" />
            <column name="english" value="Immunohistochemistry" />
            <column name="french" value="Immunohistochemistry"/>			
		</insert>
		<insert tableName="test_section" schemaName="clinlims">
			<column name="id" valueSequenceNext="test_section_seq" />
			<column name="name" value="Immunohistochemistry" />
			<column name="description" value="Immunohistochemistry Department" />
			<column name="is_external" value="N" />
			<column name="lastupdated" valueComputed="${now}"/>
			<column name="sort_order" value="2147483647" />
			<column name="is_active" value="Y" />
			<column name="name_localization_id" valueComputed="(select id from localization where description = 'Immunohistochemistry test section' and english = 'Immunohistochemistry' limit 1)" />
			<column name="display_key" value="testsection.Immunohistochemistry" />
		</insert>
	</changeSet>

	<changeSet author="mozzymutesa" id="3">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="immunohistochemistry_report" schemaName="clinlims" />
			</not>
		</preConditions>
		<comment>create immunohistochemistry_report table</comment>
		<createSequence incrementBy="1" schemaName="clinlims"
			sequenceName="immunohistochemistry_report_seq" startValue="1" />
		<createTable tableName="immunohistochemistry_report">
			<column name="id" type="INTEGER" valueSequenceNext="immunohistochemistry_report_seq">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="immunohistochemistry_sample_id" type="int"/>
			<column name="report_type" type="VARCHAR(255)"/>
			<column name="image" type="bytea"/>
			<column name="file_type" type="VARCHAR(255)"/>
			<column name="last_updated" type="datetime"/>
		</createTable>
		<addForeignKeyConstraint constraintName="immunohistochemistry_report_immunohistochemistry_sample_id_fk"
                                 baseTableName="immunohistochemistry_report" baseColumnNames="immunohistochemistry_sample_id"
                                 referencedTableName="immunohistochemistry_sample" referencedColumnNames="id"/>
	</changeSet>

	<changeSet author="mozzymutesa" id="4">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="immunohistochemistry_sample" columnName="pathology_sample_id" schemaName="clinlims" />
			</not>
		</preConditions>
		<comment>add columns to the immunohistochemistry_sample table</comment>
		<addColumn schemaName="clinlims" tableName="immunohistochemistry_sample">
			<column name="pathology_sample_id" type="INTEGER"/>
		</addColumn>
		<addColumn schemaName="clinlims" tableName="immunohistochemistry_sample">
			<column name="reffered" type="boolean"/>
		</addColumn>
		<addForeignKeyConstraint constraintName="immunohistochemistry_pathology_sample_id_fk"
                                 baseTableName="immunohistochemistry_sample" baseColumnNames="pathology_sample_id"
                                 referencedTableName="pathology_sample" referencedColumnNames="id"/>
	</changeSet>
	
</databaseChangeLog>