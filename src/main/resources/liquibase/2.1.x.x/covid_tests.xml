<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
	  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
	  
	  
  	<property name="now" value="now()" dbms="postgresql"/>

	<changeSet author="csteele" id="1" context="mauritius">
		<preConditions onFail="MARK_RAN">
			<sqlCheck  expectedResult="0">SELECT count(*) FROM clinlims.type_of_sample WHERE local_abbrev = 'Resp Swab'</sqlCheck> 
		</preConditions>
		
		<insert schemaName="clinlims" tableName="localization">
			<column name="id" valueSequenceNext="localization_seq" />
			<column name="description" value="sampleType name" />
			<column name="english" value="Respiratory Swab" />
			<column name="french" value="Ã‰couvillon respiratoire" />
			<column name="lastupdated" valueComputed="${now}" />
		</insert>
		<insert schemaName="clinlims" tableName="type_of_sample">
			<column name="id" valueSequenceNext="type_of_sample_seq" />
			<column name="description" value="Respiratory Swab" />
			<column name="domain" value="H" />
			<column name="lastupdated" valueComputed="${now}" />
			<column name="local_abbrev" value="Resp Swab" />
			<column name="is_active" value="true" />
			<column name="sort_order" value="60" />
			<column name="name_localization_id" valueComputed="(
				SELECT id FROM localization WHERE
					description = 'sampleType name' AND
					english = 'Respiratory Swab'
				)" 
			/>
			<column name="display_key" value="sample.type.respiratorySwab" />
		</insert>

		<rollback>
			<delete schemaName="clinlims" tableName="localization">
				<where>
					description = 'sampleType name' AND english = 'Respiratory Swab' 
				</where>
			</delete>
			<delete schemaName="clinlims" tableName="type_of_sample">
				<where>
					local_abbrev = 'Resp Swab' 
				</where>
			</delete>
		</rollback>
	</changeSet>

	<changeSet author="csteele" id="2" context="mauritius">
		<preConditions onFail="MARK_RAN">
			<sqlCheck  expectedResult="0">SELECT count(*) FROM clinlims.test WHERE loinc = '94500-6'</sqlCheck> 
		</preConditions>
		<insert schemaName="clinlims" tableName="localization">
			<column name="id" valueSequenceNext="localization_seq" />
			<column name="description" value="test name" />
			<column name="english" value="SARS-CoV-2 (COVID-19) RNA" />
			<column name="french" value="SARS-CoV-2 (COVID-19) RNA" />
			<column name="lastupdated" valueComputed="${now}" />
		</insert>
		<insert schemaName="clinlims" tableName="localization">
			<column name="id" valueSequenceNext="localization_seq" />
			<column name="description" value="test report name" />
			<column name="english" value="SARS-CoV-2 (COVID-19) RNA" />
			<column name="french" value="SARS-CoV-2 (COVID-19) RNA" />
			<column name="lastupdated" valueComputed="${now}" />
		</insert>
		<insert schemaName="clinlims" tableName="test">
			<column name="id" valueSequenceNext="test_seq" />
			<column name="description" value="SARS-CoV-2 (COVID-19) RNA(Respiratory Swab)" />
			<column name="loinc" value="94500-6" />
			<column name="reporting_description" value="SARS-CoV-2 (COVID-19) RNA(Respiratory Swab)" />
			<column name="is_active" value="Y" />
			<column name="is_reportable" value="N" />
			<column name="lastupdated" valueComputed="${now}" />
			<column name="test_section_id"  valueComputed="(
				SELECT id FROM test_section WHERE
					name = 'Molecular Biology'
				)" 
			/>
			<column name="local_code" value="SARS-CoV-2 (COVID-19) RNA [Presence] in Respiratory specimen by qRT-PCR" />
			<column name="sort_order" value="0" />
			<column name="name" value="SARS-CoV-2 (COVID-19) RNA" />
			<column name="orderable" value="true" />
			<column name="guid" value="a1b141dc-5e9d-47d9-8a7a-288acfe1aa2e" />
			<column name="name_localization_id" valueComputed="(
				SELECT id FROM localization WHERE
					description = 'test name' AND
					english = 'SARS-CoV-2 (COVID-19) RNA'
				)" 
			/>
			<column name="reporting_name_localization_id" valueComputed="(
				SELECT id FROM localization WHERE
					description = 'test report name' AND
					english = 'SARS-CoV-2 (COVID-19) RNA'
				)" 
			/>
			<column name="notify_results" value="true" />
		</insert>
		<insert schemaName="clinlims" tableName="sampletype_test">
			<column name="id" valueSequenceNext="sample_type_test_seq" />
			<column name="sample_type_id" valueComputed="(
				SELECT id FROM type_of_sample WHERE
					description = 'Respiratory Swab'
				)"
			/>
			<column name="test_id" valueComputed="(
				SELECT id FROM test WHERE
					description = 'SARS-CoV-2 (COVID-19) RNA(Respiratory Swab)'
				)"
			/>
			<column name="is_panel" value="false" />
		</insert>
		<insert schemaName="clinlims" tableName="test_result">
			<column name="id" valueSequenceNext="test_result_seq" />
			<column name="test_id" valueComputed="(
				SELECT id FROM test WHERE
					description = 'SARS-CoV-2 (COVID-19) RNA(Respiratory Swab)'
				)"
			/>
			<column name="tst_rslt_type" value="D" />
			<column name="value" valueComputed="(
				SELECT id FROM dictionary WHERE
					dict_entry = 'Negatif' AND
					local_abbrev = 'NEG'
				)" 
			/>
			<column name="lastupdated" valueComputed="${now}" />
			<column name="sort_order" value="10" />
			<column name="is_quantifiable" value="false" />
			<column name="is_active" value="true" />
			<column name="is_normal" value="false" />
			<column name="is_default" value="true" />
		</insert>
		<insert schemaName="clinlims" tableName="test_result">
			<column name="id" valueSequenceNext="test_result_seq" />
			<column name="test_id" valueComputed="(
				SELECT id FROM test WHERE
					description = 'SARS-CoV-2 (COVID-19) RNA(Respiratory Swab)'
				)"
			/>
			<column name="tst_rslt_type" value="D" />
			<column name="value" valueComputed="(
				SELECT id FROM dictionary WHERE
					dict_entry = 'Positif' AND
					local_abbrev = 'POSITIF'
				)" 
			/>
			<column name="lastupdated" valueComputed="${now}" />
			<column name="sort_order" value="20" />
			<column name="is_quantifiable" value="false" />
			<column name="is_active" value="true" />
			<column name="is_normal" value="false" />
			<column name="is_default" value="false" />
		</insert>
		<!-- no rollback as it gets complicated quite fast for this changeset and the test can just be disabled		 -->
	</changeSet>

	<changeSet author="csteele" id="3" context="mauritius">
		<preConditions onFail="MARK_RAN">
			<sqlCheck  expectedResult="0">SELECT count(*) FROM clinlims.test WHERE loinc = '94547-7'</sqlCheck> 
		</preConditions>
		<insert schemaName="clinlims" tableName="localization">
			<column name="id" valueSequenceNext="localization_seq" />
			<column name="description" value="test name" />
			<column name="english" value="SARS-CoV-2 (COVID-19) IgG+IgM Ab" />
			<column name="french" value="SARS-CoV-2 (COVID-19) IgG+IgM Ab" />
			<column name="lastupdated" valueComputed="${now}" />
		</insert>
		<insert schemaName="clinlims" tableName="localization">
			<column name="id" valueSequenceNext="localization_seq" />
			<column name="description" value="test report name" />
			<column name="english" value="SARS-CoV-2 (COVID-19) IgG+IgM Ab" />
			<column name="french" value="SARS-CoV-2 (COVID-19) IgG+IgM Ab" />
			<column name="lastupdated" valueComputed="${now}" />
		</insert>
		<insert schemaName="clinlims" tableName="test">
			<column name="id" valueSequenceNext="test_seq" />
			<column name="description" value="SARS-CoV-2 (COVID-19) IgG+IgM Ab (Serum)" />
			<column name="loinc" value="94547-7" />
			<column name="reporting_description" value="SARS-CoV-2 (COVID-19) IgG+IgM Ab (Serum)" />
			<column name="is_active" value="Y" />
			<column name="is_reportable" value="N" />
			<column name="lastupdated" valueComputed="${now}" />
			<column name="test_section_id"  valueComputed="(
				SELECT id FROM test_section WHERE
					name = 'Molecular Biology'
				)" 
			/>
			<column name="local_code" value="SARS-CoV-2 (COVID-19) IgG+IgM Ab [Presence] in Serum by Immunoassay" />
			<column name="sort_order" value="0" />
			<column name="name" value="SARS-CoV-2 (COVID-19) IgG+IgM Ab" />
			<column name="orderable" value="true" />
			<column name="guid" value="bb65fea5-4a3f-48e3-9cd1-637da2cf588c" />
			<column name="name_localization_id" valueComputed="(
				SELECT id FROM localization WHERE
					description = 'test name' AND
					english = 'SARS-CoV-2 (COVID-19) IgG+IgM Ab'
				)" 
			/>
			<column name="reporting_name_localization_id" valueComputed="(
				SELECT id FROM localization WHERE
					description = 'test report name' AND
					english = 'SARS-CoV-2 (COVID-19) IgG+IgM Ab'
				)" 
			/>
			<column name="notify_results" value="true" />
		</insert>
		<insert schemaName="clinlims" tableName="sampletype_test">
			<column name="id" valueSequenceNext="sample_type_test_seq" />
			<column name="sample_type_id" valueComputed="(
				SELECT id FROM type_of_sample WHERE
					description = 'Serum'
				)"
			/>
			<column name="test_id" valueComputed="(
				SELECT id FROM test WHERE
					description = 'SARS-CoV-2 (COVID-19) IgG+IgM Ab (Serum)'
				)"
			/>
			<column name="is_panel" value="false" />
		</insert>
		<insert schemaName="clinlims" tableName="test_result">
			<column name="id" valueSequenceNext="test_result_seq" />
			<column name="test_id" valueComputed="(
				SELECT id FROM test WHERE
					description = 'SARS-CoV-2 (COVID-19) IgG+IgM Ab (Serum)'
				)"
			/>
			<column name="tst_rslt_type" value="D" />
			<column name="value" valueComputed="(
				SELECT id FROM dictionary WHERE
					dict_entry = 'Negatif' AND
					local_abbrev = 'NEG'
				)" 
			/>
			<column name="lastupdated" valueComputed="${now}" />
			<column name="sort_order" value="10" />
			<column name="is_quantifiable" value="false" />
			<column name="is_active" value="true" />
			<column name="is_normal" value="false" />
			<column name="is_default" value="true" />
		</insert>
		<insert schemaName="clinlims" tableName="test_result">
			<column name="id" valueSequenceNext="test_result_seq" />
			<column name="test_id" valueComputed="(
				SELECT id FROM test WHERE
					description = 'SARS-CoV-2 (COVID-19) IgG+IgM Ab (Serum)'
				)"
			/>
			<column name="tst_rslt_type" value="D" />
			<column name="value" valueComputed="(
				SELECT id FROM dictionary WHERE
					dict_entry = 'Positif' AND
					local_abbrev = 'POSITIF'
				)" 
			/>
			<column name="lastupdated" valueComputed="${now}" />
			<column name="sort_order" value="20" />
			<column name="is_quantifiable" value="false" />
			<column name="is_active" value="true" />
			<column name="is_normal" value="false" />
			<column name="is_default" value="false" />
		</insert>

		<insert schemaName="clinlims" tableName="test">
			<column name="id" valueSequenceNext="test_seq" />
			<column name="description" value="SARS-CoV-2 (COVID-19) IgG+IgM Ab (Plasma)" />
			<column name="loinc" value="94547-7" />
			<column name="reporting_description" value="SARS-CoV-2 (COVID-19) IgG+IgM Ab (Plasma)" />
			<column name="is_active" value="Y" />
			<column name="is_reportable" value="N" />
			<column name="lastupdated" valueComputed="${now}" />
			<column name="test_section_id"  valueComputed="(
				SELECT id FROM test_section WHERE
					name = 'Molecular Biology'
				)" 
			/>
			<column name="local_code" value="SARS-CoV-2 (COVID-19) IgG+IgM Ab [Presence] in Plasma by Immunoassay" />
			<column name="sort_order" value="0" />
			<column name="name" value="SARS-CoV-2 (COVID-19) IgG+IgM Ab" />
			<column name="orderable" value="true" />
			<column name="guid" value="45dc1802-5cbe-4345-bc84-9792487d2e27" />
			<column name="name_localization_id" valueComputed="(
				SELECT id FROM localization WHERE
					description = 'test name' AND
					english = 'SARS-CoV-2 (COVID-19) IgG+IgM Ab'
				)" 
			/>
			<column name="reporting_name_localization_id" valueComputed="(
				SELECT id FROM localization WHERE
					description = 'test report name' AND
					english = 'SARS-CoV-2 (COVID-19) IgG+IgM Ab'
				)" 
			/>
			<column name="notify_results" value="true" />
		</insert>
		<insert schemaName="clinlims" tableName="sampletype_test">
			<column name="id" valueSequenceNext="sample_type_test_seq" />
			<column name="sample_type_id" valueComputed="(
				SELECT id FROM type_of_sample WHERE
					description = 'Plasma'
				)"
			/>
			<column name="test_id" valueComputed="(
				SELECT id FROM test WHERE
					description = 'SARS-CoV-2 (COVID-19) IgG+IgM Ab (Plasma)'
				)"
			/>
			<column name="is_panel" value="false" />
		</insert>
		<insert schemaName="clinlims" tableName="test_result">
			<column name="id" valueSequenceNext="test_result_seq" />
			<column name="test_id" valueComputed="(
				SELECT id FROM test WHERE
					description = 'SARS-CoV-2 (COVID-19) IgG+IgM Ab (Plasma)'
				)"
			/>
			<column name="tst_rslt_type" value="D" />
			<column name="value" valueComputed="(
				SELECT id FROM dictionary WHERE
					dict_entry = 'Negatif' AND
					local_abbrev = 'NEG'
				)" 
			/>
			<column name="lastupdated" valueComputed="${now}" />
			<column name="sort_order" value="10" />
			<column name="is_quantifiable" value="false" />
			<column name="is_active" value="true" />
			<column name="is_normal" value="false" />
			<column name="is_default" value="true" />
		</insert>
		<insert schemaName="clinlims" tableName="test_result">
			<column name="id" valueSequenceNext="test_result_seq" />
			<column name="test_id" valueComputed="(
				SELECT id FROM test WHERE
					description = 'SARS-CoV-2 (COVID-19) IgG+IgM Ab (Plasma)'
				)"
			/>
			<column name="tst_rslt_type" value="D" />
			<column name="value" valueComputed="(
				SELECT id FROM dictionary WHERE
					dict_entry = 'Positif' AND
					local_abbrev = 'POSITIF'
				)" 
			/>
			<column name="lastupdated" valueComputed="${now}" />
			<column name="sort_order" value="20" />
			<column name="is_quantifiable" value="false" />
			<column name="is_active" value="true" />
			<column name="is_normal" value="false" />
			<column name="is_default" value="false" />
		</insert>
		<!-- no rollback as it gets complicated quite fast for this changeset and the test can just be disabled		 -->
	</changeSet>

</databaseChangeLog>